<html>
  <head>
  
  <style>
    html, body {
      font-family: verdana, meiryo, sans-serif, Arial Unicode MS, Cambria Math;
    }

  
    .molmil_UI_container {
      border: 1px solid black;
    }
    
    #mm_title {
      font-size: 3em;
      margin-bottom: 0px;
    }
    
    #infoBox {
      display: block;
    }
    
    #pdbid_container {
      color: #cc0000;
      font-weight: bold;
      font-size: 2em;
    }
    
    #pdbid_container .fls {
      margin-left: -0.25em;
      margin-right: 0.25em;
      font-style: italic;
      color: #020166;
      font-weight: bold;
    }
    
    #fSiteBox {
      display: inline-block;
      text-align: left;
    }
    
    #goto_top {
      position: absolute;
      top: 0px;
      left: 0px;
      color: grey;
    }
    
    #goto_top:hover {color: red;}
    
  </style>
  
  <script>  
  
var molmil_settings = {
  src: "../",
};
    var canvas, canvas2, pdbid, efID, chainsList, preMode;
    
    var efAPI = "https://pdbj.org/eF-site/rest/showefvet?id=";
    var mpbfAPI = "https://pdbj.org/rest/displayEFSiteFile";
    var credentials = null;
  
    window.addEventListener("message", function(ev) {
      var jso = JSON.parse(ev.data);
      if (jso.credentials) credentials = JSON.parse(jso.credentials);
    }, false);
  
  
    //extracts a utf-8 string from binary data
    function decodeUtf8(arrayBuffer) {
      var result = "", i = 0, c = 0, c1 = 0, c2 = 0, data = new Uint8Array(arrayBuffer);
 
      // If we have a BOM skip it
      if (data.length >= 3 && data[0] === 0xef && data[1] === 0xbb && data[2] === 0xbf) i = 3;
 
      while (i < data.length) {
        c = data[i];
 
        if (c < 128) {
          result += String.fromCharCode(c);
          i++;
        } 
        else if (c > 191 && c < 224) {
          if( i+1 >= data.length ) throw "UTF-8 Decode failed. Two byte character was truncated.";
          c2 = data[i+1];
          result += String.fromCharCode( ((c&31)<<6) | (c2&63) );
          i += 2;
        } 
        else {
          if (i+2 >= data.length) throw "UTF-8 Decode failed. Multi byte character was truncated.";
          c2 = data[i+1];
          c3 = data[i+2];
          result += String.fromCharCode( ((c&15)<<12) | ((c2&63)<<6) | (c3&63) );
          i += 3;
        }
      }
      return result;
    }
  
    // render geometry when loading has finished
    function finalizeSurface(soup, models) {
      if (Math.abs(canvas.molmilViewer.geomRanges[0])+Math.abs(canvas.molmilViewer.geomRanges[1]) == 0) return molmil_dep.asyncStart(finalizeSurface, [], null, 50);

      molmil.safeStartViewer(canvas2);
      
      canvas2.molmilViewer.avgXYZ = canvas.molmilViewer.avgXYZ;
      canvas2.molmilViewer.stdXYZ = canvas.molmilViewer.stdXYZ;
      canvas2.molmilViewer.COR = canvas.molmilViewer.COR;
          
      canvas2.renderer.initBuffers();
      canvas2.update = true;
    };
  
  
    // load & display efvet data
    function processEFvet() {
      this.OnError = null;
      canvas2.parentNode.style.display = "";
      
      var data = this.request.responseText.split("\n"), info, i, line, ep, hp, r, g, b, triangles_list = [];
      info = data[0].split(/\s/);
      info.unshift(1);
      
      for (i=1; i<info.length; i++) info[i] = parseInt(info[i])+info[i-1];
      
      var struct = new molmil.polygonObject({filename: "", COR: [0, 0, 0]}); canvas2.molmilViewer.structures.push(struct);
      struct.options = [];
      
      // load efvet data and convert into vertex & index arrays
      var vertices = new Float32Array((info[1]-info[0])*7);
      var vertices8 = new Uint8Array(vertices.buffer);
      var indices = new Int32Array((info[3]-info[2])*3);
      var offset = 0, offset8 = 0;
      
      var total_prop = [0, 0, 0];
      
      for (i=info[0]; i<info[1]; i++, offset+=7, offset8+=28) {
        line = data[i];
         
        ep = (Math.min(Math.max((parseFloat(line.substring(62, 73))+.1)/(.2), 0), 1)*2)-1;
        hp = (parseFloat(line.substring(73, 84))+4.5)/9;
        
        total_prop[0] += parseFloat(line.substring(62, 73)); 
        total_prop[1] += hp; 
        total_prop[2] += 1;
          
        r = g = b = 1;
          
        if (ep < 0) {
          g = 1+ep+(hp*.5);
          b = 1+ep;
        }
        else {
          r = 1-ep;
          g = 1-ep+(hp);
          b = 1-hp;
        }
         
        r = Math.min(Math.max(r, 0), 1);
        g = Math.min(Math.max(g, 0), 1);
        b = Math.min(Math.max(b, 0), 1);
        
        vertices[offset+0] = parseFloat(line.substring(0, 12));
        vertices[offset+1] = parseFloat(line.substring(12, 25)); 
        vertices[offset+2] = parseFloat(line.substring(25, 38)); 
        vertices[offset+3] = parseFloat(line.substring(38, 46)); 
        vertices[offset+4] = parseFloat(line.substring(46, 54)); 
        vertices[offset+5] = parseFloat(line.substring(54, 62));
        
        vertices8[offset8+24] = r*255;
        vertices8[offset8+25] = g*255;
        vertices8[offset8+26] = b*255;
        vertices8[offset8+27] = 255;
      }
      
      total_prop[0] /= total_prop[2]; total_prop[1] /= total_prop[2];
      
      //console.log("Protein total charge: ", total_prop[0].toFixed(2));
      //console.log("Protein average hydrophobicity: ", (total_prop[1]*100).toFixed(2), "%");
      
      offset = 0;

      for (i=info[2]; i<info[3]; i++, offset+=3) {
        line = data[i].match(/\S+/g);
        indices[offset+0] = parseInt(line[3])-1
        indices[offset+1] = parseInt(line[4])-1;
        indices[offset+2] = parseInt(line[5])-1;
      }
    
      // upload data to gpu & register render programs
      var program = molmil.geometry.build_simple_render_program(vertices, indices, canvas2.renderer, {solid: true, storeVertices: true});
      canvas2.renderer.programs.push(program);
      struct.programs.push(program);

      setupOptions([]); // protein/xna
        
      finalizeSurface(canvas2.molmilViewer, []);
    }

    // load & display mpbf data
    function processMPBF(soup, struct) {
      var options = [], chains = [];
      
      for (var i=0; i<struct.options.length; i++) {
        if (struct.options[i][0].substr(4, 7) == " chain ") chains.push([struct.options[i][0].substr(11), struct.options[i][1]]);
        else options.push(struct.options[i]);
      }
        
      setupOptions(options, chains); // protein/xna
        
      finalizeSurface(canvas2.molmilViewer, []);
    }
    
    function setupOptions(options, chains) {
      if (chains && chains.length) {
        var psi2ai = {};
        var data = canvas.molmilViewer.jso["data_"+pdbid.toUpperCase()];
        for (var i=0; i<data.pdbx_poly_seq_scheme.asym_id.length; i++) psi2ai[data.pdbx_poly_seq_scheme.pdb_strand_id[i]] = data.pdbx_poly_seq_scheme.asym_id[i];
        
        var ai_chains = {};
        for (var i=0; i<chains.length; i++) chains[i][0] = psi2ai[chains[i][0]];
        
        options.push(["Biological Unit", null, chains]);
      }
      
      
    
      var option_field = document.getElementById("option_field");
      
      if (options.length > 1 || (chains && chains.length)) {
        option_field.style.display = "";
        var select = option_field.childNodes[3], opt, opt_all; select.innerHTML = "";
        opt_all = select.pushNode(molmil_dep.dcEi("option", "All")); select.opt_all = opt_all;
        opt_all.programs = [];
        for (var o=0; o<options.length; o++) {
          opt = select.pushNode(molmil_dep.dcEi("option", options[o][0]));
          if (options[o][1] == null) {
            opt.chains = options[o][2];
            opt.programs = null;
            select.has_BU = true;
          }
          else {
            opt.programs = [options[o][1]];
            opt_all.programs.push(options[o][1]);
          }
        }
        
        select.onchange = function() {
          var programs = this.opt_all.programs, p;
          for (p=0; p<programs.length; p++) programs[p].status = false;
          programs = this.options[this.selectedIndex].programs;
          if (programs == null) {
            molmil.toggleBU(1, 12, null, canvas.molmilViewer);
            var chains = this.options[this.selectedIndex].chains;
            for (var i=0; i<chains.length; i++) {
              if (canvas.molmilViewer.sceneBU.chainInfo.hasOwnProperty(chains[i][0])) {
                chains[i][1].status = true;
              }
              else {
                chains[i][1].status = false;
              }
            }
            this.chainSelection = chains;
          }
          else {
            if (this.has_BU) {
              canvas2.molmilViewer.COR = canvas.molmilViewer.COR = JSON.parse(JSON.stringify(canvas.molmilViewer.sceneBU.COR));
              canvas2.molmilViewer.geomRanges = canvas.molmilViewer.geomRanges = JSON.parse(JSON.stringify(canvas.molmilViewer.sceneBU.geomRanges));
              canvas.molmilViewer.sceneBU = null;
              document.getElementById("option_field").childNodes[3].currentDisplayMode();
              
              var chains = this.chainSelection;
              for (var i=0; i<chains.length; i++) chains[i][1].status = true;
            }
          
          
            for (p=0; p<programs.length; p++) programs[p].status = true;
            var tag = this.options[this.selectedIndex].innerHTML;
            var c, m, a, mol;
          
            var status = tag.toLowerCase() == "all";
          
            for (c=0; c<canvas.molmilViewer.structures[0].chains.length; c++) {
              for (m=0; m<canvas.molmilViewer.structures[0].chains[c].molecules.length; m++) {
                mol = canvas.molmilViewer.structures[0].chains[c].molecules[m];
                mol.status = status;
                for (a=0; a<mol.atoms.length; a++) mol.atoms[a].status = status;
              }
            }
          
            if (tag.indexOf("protein chains") != -1) {
              for (c=0; c<canvas.protein_chains.length; c++) {
                for (m=0; m<canvas.protein_chains[c].molecules.length; m++) {
                  mol = canvas.protein_chains[c].molecules[m];
                  mol.status = true;
                  for (a=0; a<mol.atoms.length; a++) mol.atoms[a].status = true;
                }
              }
            }
            else if (tag.indexOf("dna/rna chains") != -1) {
              for (c=0; c<canvas.xna_chains.length; c++) {
                for (m=0; m<canvas.xna_chains[c].molecules.length; m++) {
                  mol = canvas.xna_chains[c].molecules[m];
                  mol.status = true;
                  for (a=0; a<mol.atoms.length; a++) mol.atoms[a].status = true;
                }
              }
            }
          }
          
          canvas.update = true;
          canvas.renderer.initBuffers();
          
        };
        
      }
      else {
        option_field.style.display = "none";
      }
    }
  
    window.onresize = function() {
      if (document.fullscreenElement) {
        var sc = document.fullscreenElement.getElementsByTagName("canvas")[0];
        var dpr = window.devicePixelRatio || 1;
        var w = (window.innerWidth || document.documentElement.clientWidth) * dpr;
        var h = (window.innerHeight || document.documentElement.clientHeight) * dpr;
        sc.setSize(w, h);
        return;
      }

      if (canvas && window.innerHeight != screen.height) {
        var dpr = window.devicePixelRatio || 1;
        var w = ((window.innerWidth || document.documentElement.clientWidth)/3) * dpr;
        var h = ((window.innerHeight || document.documentElement.clientHeight)/2) * dpr;
        canvas.setSize(w, h);
        canvas2.setSize(w, h);
      }
    };
  
    function initViewer() {
      
      if (! window.molmil.configBox || ! molmil.configBox.initFinished) {return setTimeout(initViewer, 100);}

      if (! canvas) {
        canvas = document.getElementById("molmilViewer");
        canvas2 = document.getElementById("molmilViewer2");
        canvas.width = (window.innerWidth || document.documentElement.clientWidth)/3;
        canvas.height = (window.innerHeight || document.documentElement.clientHeight)/2;
      
        canvas2.width = (window.innerWidth || document.documentElement.clientWidth)/3;
        canvas2.height = (window.innerHeight || document.documentElement.clientHeight)/2;
      
        canvas = molmil.createViewer(canvas);
        canvas2 = molmil.createViewer(canvas2);
        if (! canvas) return false;
        
        canvas2.molmilViewer.skipCOGupdate = true;
      }
      else {
        canvas.molmilViewer.clear(); canvas.renderer.initBuffers(); canvas.renderer.camera.reset();
        canvas2.molmilViewer.clear(); canvas2.renderer.initBuffers(); canvas2.renderer.programs = [];
        canvas.displayMode = 0;
      }
      
      efID = window.location.hash.replace(/#(\!)?/, ''); preMode = false;
      if (efID.substr(0, 4) == "pre/") {
        if (credentials == null) return setTimeout(initViewer, 100);
        efID = efID.substr(4);
        preMode = true;
      }
      pdbid = efID.substr(0, 4);
      var modelId = (parseInt((efID.split("_")[1] || "").split("-")) || 1)-1;
      
      var infoBox = document.getElementById("infoBox"), inp, lbl; infoBox.innerHTML = "";
      lbl = infoBox.pushNode("label"); inp = lbl.pushNode("input"); inp.type = "radio"; inp.name = "displayStyle"; lbl.pushNode("span", "Cartoon"); lbl.style.marginRight = "1em"; lbl.onclick = selectDisplayDefault;
      lbl = infoBox.pushNode("label"); inp = lbl.pushNode("input"); inp.type = "radio"; inp.name = "displayStyle"; lbl.pushNode("span", "Wireframe"); lbl.style.marginRight = "1em"; lbl.onclick = selectWireframe;
      lbl = infoBox.pushNode("label"); inp = lbl.pushNode("input"); inp.type = "radio"; inp.name = "displayStyle"; lbl.pushNode("span", "CPK"); lbl.style.marginRight = "1em"; lbl.onclick = selectDisplayCPK;
      lbl = infoBox.pushNode("label"); inp = lbl.pushNode("input"); inp.type = "radio"; inp.name = "displayStyle"; lbl.pushNode("span", "Cartoon without hetero atoms "); lbl.style.marginRight = "1em"; lbl.onclick = selectDisplayDefaultNoHET;
      
      lbl = infoBox.pushNode("a", "Help"); lbl.href = "http://pdbj.org/help/ef-site"; lbl.target = "_blank"; lbl.style.marginRight = "1em";
      lbl.onclick = function() {window.open(this.href, "", "height="+(screen.height*.75)+",width="+(screen.width*.75)+",top="+(screen.height*.125)+",left="+(screen.width*.125)+",modal=yes,alwaysRaised=yes,scrollbars=yes"); return false;};
      
      molmil.linkCanvases([canvas, canvas2]);
      
      molmil.autoSetup({enable: ["ui", "cli"]});

      if (! efID) return;
      
      canvas.molmilViewer.skipCOGupdate = true;
      
      var pdbid_container = document.getElementById("pdbid_container"); 
      var tmp = efID.split("-");
      chainsList = (tmp[1] || "").trim();
      if (tmp[0].toLowerCase().indexOf(".mpbf") == -1) pdbid_container.innerHTML = tmp[0].toLowerCase() + (tmp.length > 1 ? "-"+tmp[1].toUpperCase() : "");
      else {
        //pdbid_container.innerHTML = tmp[0].toLowerCase().replace(".mpbf", "") + (tmp.length > 1 ? "-"+tmp[1].toUpperCase() : "");
        pdbid_container.innerHTML = "";
        var fls = pdbid_container.pushNode("span", "for large structures");
        fls.className = "fls";
        pdbid_container.pushNode("span", tmp[0].toLowerCase().replace(".mpbf", "") + (tmp.length > 1 ? "-"+tmp[1].toUpperCase() : ""));
        
      }

      var request = new molmil_dep.CallRemote("GET"); request.ASYNC = true; request.responseType = "json";
      request.OnDone = function() {
        //var jso = JSON.parse(this.request.responseText);
        var jso = this.request.response;
        if (typeof jso != "object" && jso != null) jso = JSON.parse(this.request.responseText);
        canvas.molmilViewer.jso = jso;
        canvas.renderer.modelId = molmil.geometry.modelId = modelId;
        canvas.molmilViewer.loadStructureData(jso, 1, pdbid, function(soup, models) {});
      };
      request.OnError = function() {document.getElementById("pdbid_container").innerHTML = "Unknown entry: "+efID;};
      request.Send(molmil_settings.pdb_url.replace("__ID__", pdbid));
      
      var request = new molmil_dep.CallRemote("GET"); request.ASYNC = true;
      request.OnDone = function() {
        if (! canvas.molmilViewer.structures.length) return molmil_dep.asyncStart(this.OnDone, [], this, 50);
        
        var data = canvas.molmilViewer.jso["data_"+pdbid.toUpperCase()];
        
        
        var protein_chains = [], xna_chains = [];
        var entity_poly = data.entity_poly || {entity_id: []};
        for (var i=0; i<entity_poly.entity_id.length; i++) {
          if (entity_poly.type[i] == "polypeptide(D)" || entity_poly.type[i] == "polypeptide(L)") protein_chains = protein_chains.concat(entity_poly.pdbx_strand_id[i].split(","));
          else if (entity_poly.type[i] == "polydeoxyribonucleotide/polyribonucleotide hybrid" || entity_poly.type[i] == "polydeoxyribonucleotide" || entity_poly.type[i] == "polyribonucleotide") xna_chains = xna_chains.concat(entity_poly.pdbx_strand_id[i].split(","));
        }
        
        if (chainsList.length) {
          var chainsList2 = null;
          if (chainsList.indexOf('.') >= 0) {
            chainsList2 = chainsList.split('.');
          }
          for (var c=0, m, mol, a; c<canvas.molmilViewer.structures[0].chains.length; c++) {
            if (chainsList2 != null) {
              if (chainsList2.indexOf(canvas.molmilViewer.structures[0].chains[c].authName) == -1) {canvas.molmilViewer.structures[0].chains.splice(c, 1); c--;}
            } else {
              if (chainsList.indexOf(canvas.molmilViewer.structures[0].chains[c].authName) == -1) {canvas.molmilViewer.structures[0].chains.splice(c, 1); c--;}
            }
          }
        }
        else {
          for (var c=0, m, mol, a; c<canvas.molmilViewer.structures[0].chains.length; c++) {
            m = protein_chains.indexOf(canvas.molmilViewer.structures[0].chains[c].authName);
            if (m != -1) protein_chains[m] = canvas.molmilViewer.structures[0].chains[c];
            else {
              m = xna_chains.indexOf(canvas.molmilViewer.structures[0].chains[c].authName);
              if (m != -1) xna_chains[m] = canvas.molmilViewer.structures[0].chains[c];
            }
          }
          for (var i=0; i<protein_chains.length; i++) {if (! protein_chains[i] instanceof molmil.chainObject) {protein_chains = protein_chains.splice(i, 1); i--;}}
          for (var i=0; i<xna_chains.length; i++) {if (! xna_chains[i] instanceof molmil.chainObject) {xna_chains = xna_chains.splice(i, 1); i--;}}
        }
        canvas.protein_chains = protein_chains;
        canvas.xna_chains = xna_chains;
        
        canvas.molmilViewer.skipCOGupdate = false;
        canvas.molmilViewer.calculateCOG();
        canvas.renderer.camera.z = canvas.molmilViewer.calcZ();

        var buffer_ = data.struct_site || {id: []};
        var buffer2_ = mmjsonGroupData(data.struct_site_gen, "site_id");
        var buffer = {info_subtype: []}, buffer2 = [];
        
        if (this.request.responseText) {
          var jso = JSON.parse(this.request.responseText);
          var plus = jso["data_"+pdbid.toUpperCase()+"-plus"];

          buffer = plus.struct_site_pdbmlplus || {id: [], info_subtype: []};
          buffer2 = mmjsonGroupData(plus.struct_site_gen_pdbmlplus, "site_id");
        }
       
        // not sure why this was disabled....
        /*if (efID.substr(4).toLowerCase() == ".mpbf") {
          buffer = [];
          buffer_ = {id: []};
        }*/
       
        for (var e in buffer_) {
          if (! buffer.hasOwnProperty(e)) buffer[e] = [];
          buffer[e].push.apply(buffer[e], buffer_[e]);
        }
        for (var e=0; e<buffer_.id.length; e++) buffer.info_subtype.push("pdb");
        
        for (var e in buffer2_) buffer2[e] = buffer2_[e];
        
        var fgroups = [], fgroup;
        
        var chainid, resid, residx, residx2, chains, c, r, tmp, tmp2, tmpList, seq, i, j, mol;
        var model = canvas.molmilViewer.structures[0];
        
        var aaCode = {"ALA":"A","CYS":"C","ASP":"D","GLU":"E","PHE":"F","GLY":"G","HIS":"H","ILE":"I","LYS":"K","LEU":"L","MET":"M","ASN":"N","PYL":"O","PRO":"P","GLN":"Q","ARG":"R","SER":"S","THR":"T","SEC":"U","VAL":"V","TRP":"W","TYR":"Y"} ;
        
        for (i=0; i<buffer.id.length; i++) {
          if (! buffer.info_subtype) break;
          
          fgroup = {
            name: "", 
            sequence: "",
            description: buffer.details[i],
            source: buffer.info_subtype[i]+" : "+buffer.id[i],
            residueList: [] // list of molObject/s 
          };
          
          residues = buffer2[buffer.id[i]] || [];
          tmp = [];
          fgroup.ligand = residues.length ? residues[0].ligand : null;
          if (buffer.info_subtype[i] == "binding" || buffer.info_subtype[i] == "prosite") {
            for (r=0; r<residues.length; r++) {
              tmpList = [];
              
              chainid = residues[r].auth_asym_id;
              if (chainsList.length && chainsList.indexOf(chainid) == -1) continue;
              residx = parseInt(residues[r].beg_auth_seq_id);
              residx2 = parseInt(residues[r].end_auth_seq_id);

              chains = canvas.molmilViewer.getChainAuth(model, chainid);
              
              if (fgroup.sequence.length) fgroup.sequence += ", ";
              for (c=residx; c<=residx2; c++) {
                mol = canvas.molmilViewer.getMolObject4ChainAlt(chains, c);
                if (! mol) continue;
                fgroup.sequence += aaCode[mol.name] || ""; fgroup.residueList.push(mol);
              }

              tmp.push([chainid+": "+residues[r].beg_auth_seq_id+(residues[r].beg_auth_seq_id != residues[r].end_auth_seq_id ? "-"+residues[r].end_auth_seq_id : "")]);
            }
          }
          else /*if (buffer.info_subtype[i] == "ACT_SITE" || buffer.info_subtype[i] == "NP_BIND" || buffer.info_subtype[i] == "BINDING" || buffer.info_subtype[i] == "DNA_BIND" || buffer.info_subtype[i] == "pdb") */{
            for (r=0; r<residues.length; r++) {
              tmpList = [];
              chainid = residues[r].auth_asym_id; residx = null; tmp2 = [], residx = residx2 = null;
              if (chainsList.length && chainsList.indexOf(chainid) == -1) continue;
              if (residues[r].beg_auth_seq_id) {
                try {
                  residx = parseInt(residues[r].beg_auth_seq_id.replace(/\D/g,''));
                  residx2 = parseInt(residues[r].end_auth_seq_id.replace(/\D/g,''));
                  tmp2 = [residues[r].beg_auth_seq_id, residues[r].end_auth_seq_id];
                }
                catch (e) {}
              }
              if (residx == null) {
                if (! residues[r].auth_seq_id) continue;
                resid2 = residx = parseInt(residues[r].auth_seq_id.replace(/\D/g,''));
                tmp2 = [null, null];
              }
              if (! residx2) residx2 = residx;

              chains = canvas.molmilViewer.getChainAuth(model, chainid);
              if (fgroup.sequence.length) fgroup.sequence += ", ";
              for (c=residx; c<=residx2; c++) {
                mol = canvas.molmilViewer.getMolObject4ChainAlt(chains, c);
                if (! mol) continue;
                fgroup.sequence += aaCode[mol.name] || "";
                fgroup.residueList.push(mol);
              }

              try {
                if (tmp2[0] == null) tmp2 = [canvas.molmilViewer.getMolObject4ChainAlt(chains, residx).RSID, canvas.molmilViewer.getMolObject4ChainAlt(chains, residx2).RSID];
              }
              catch (e) {}
  
              if (tmp2[0] != null) tmp.push([chainid+": "+tmp2[0]+(tmp2[0] != tmp2[1] ? "-"+tmp2[1] : "")]);
            }

          }
          
          fgroup.name = tmp.join(", ")+(buffer.info_subtype[i] != "pdb" ? " ("+buffer.info_subtype[i]+")" : "");
          if (fgroup.residueList.length) fgroups.push(fgroup);
        }
        
        // build table...
        
        var tbl = molmil_dep.dcE("table"), tr, td, tbl2, tr2, td2, check;
        tr = tbl.pushNode("tr");
        tr.style.color = "#cc0000";
        tr.pushNode("td", "");
        tr.pushNode("td", "");
        
        var site_color_list = [[0, 127, 255, 255], [153, 102, 255, 255], [255, 165, 0, 255], [255, 255, 0, 255], [0, 255, 255, 255], [255, 192, 203, 255], [0, 255, 0, 255], [255, 0, 0, 255]];
        var n = 0;
        var arr = [];
        for (var i=0; i<fgroups.length; i++) {
          tr = tbl.pushNode("tr");
          td = tr.pushNode("td");
          td.style.verticalAlign = "top";
          td.style.paddingTop = ".4em";
          check = td.pushNode("input");
          check.type = "checkbox";
          check.onclick = toggleSite;
          check.data = fgroups[i];
          check.data.color = [site_color_list[n][0], site_color_list[n][1], site_color_list[n][2], 255];
          arr.push(check);
          
          td = tr.pushNode("td");
          tbl2 = td.pushNode("table");
          
          tr2 = tbl2.pushNode("tr");
          td2 = tr2.pushNode("td", fgroups[i].name);
          td2.colSpan = 2;
          td2.style.backgroundColor = "#003366";
          td2.style.color = "rgba("+site_color_list[n].join(",")+")";
          td2.style.fontWeight = "bold";
          td2.style.padding = ".25em";
          
          if (fgroups[i].sequence) {
            tr2 = tbl2.pushNode("tr"); 
            td2 = tr2.pushNode("td", "Sequence:"); 
            td2.style.color = "#cc0000";
            tr2.pushNode("td", fgroups[i].sequence);
          }
          if (fgroups[i].description) {
            tr2 = tbl2.pushNode("tr"); 
            td2 = tr2.pushNode("td", "Description:"); 
            td2.style.color = "#cc0000";
            tr2.pushNode("td", fgroups[i].description);
          }
          if (fgroups[i].source) {
            tr2 = tbl2.pushNode("tr"); 
            td2 = tr2.pushNode("td", "Source:"); 
            td2.style.color = "#cc0000";
            tr2.pushNode("td", fgroups[i].source);
          }
          if (fgroups[i].ligand) {
            tr2 = tbl2.pushNode("tr"); 
            td2 = tr2.pushNode("td", "Ligand:"); 
            td2.style.color = "#cc0000";
            tr2.pushNode("td", fgroups[i].ligand);
          }
          
          n += 1;
          if (n >= site_color_list.length) n = 0;
        }
        
        var fSiteBox = document.getElementById("fSiteBox");
        fSiteBox.innerHTML = "";
        // also add some title
        //struct.title 
        
        var title = fSiteBox.pushNode("a");
        title.style.fontWeight = "bold";
        title.style.fontSize = "1.25em";
        title.href = "http://pdbj.org/mine/summary/"+pdbid;
        title.target = "_blank";
        title.onclick = function() {window.open(this.href, "", "height="+(screen.height*.75)+",width="+(screen.width*.75)+",top="+(screen.height*.125)+",left="+(screen.width*.125)+",modal=yes,alwaysRaised=yes,scrollbars=yes"); return false;};
        if (canvas.molmilViewer.jso["data_"+pdbid.toUpperCase()].struct && canvas.molmilViewer.jso["data_"+pdbid.toUpperCase()].struct.title) title.innerHTML = (canvas.molmilViewer.jso["data_"+pdbid.toUpperCase()].struct.title[0] || "").toUpperCase();
        else title.innerHTML = "PDBj Mine";
        
        
        fSiteBox.pushNode(tbl);
        
        var clear = fSiteBox.pushNode("button", "Clear");
        clear.arr = arr;
        clear.onclick = function() {
          for (var i=0; i<this.arr.length; i++) {
            if (this.arr[i].data.enabled) {this.arr[i].data.enabled = false; this.arr[i].data.update = true; this.arr[i].checked = false;}
          }
          
          displaySites();
        };
        if (fgroups.length == 0) clear.style.display = "none";
        
        canvas.fgroups = fgroups;
        if (canvas.molmilViewer.AID > 1e5) document.getElementById("infoBox").firstChild.nextSibling.firstChild.click();
        else document.getElementById("infoBox").firstChild.firstChild.click();
      };
      request.OnError = request.OnDone;
      request.Send(molmil_settings.pdb_url.replace("__ID__", pdbid).replace("format=mmjson-all", "format=mmjson-plus-add"));
      
      //canvas.molmilViewer.loadStructure(molmil_settings.pdb_url.replace("__ID__", pdbid), 1, ondone);
      if (efID.substr(efID.length-5).toLowerCase() != ".mpbf") {
        var request = new molmil_dep.CallRemote("GET"); request.ASYNC = true;
        request.OnDone = processEFvet;
        request.OnError = function() {
          canvas2.parentNode.style.display = "none";
          var msg = document.getElementById("infoBox").pushNode("div", "Electrostatic surface data is unavailable...");
          msg.style.color = "red";
        }
        request.Send(efAPI+efID);
      }
      else {
        var request = new molmil_dep.CallRemote("POST"); request.ASYNC = true;
        request.responseType = "arraybuffer";
        request.OnDone = function() {
          this.OnError = null;
          canvas2.molmilViewer.loadStructureData(this.request.response, "mpbf", pdbid+".mpbf", processMPBF);
        };
        request.OnError = function() {
          canvas2.parentNode.style.display = "none";
          var msg = document.getElementById("infoBox").pushNode("div", "Electrostatic surface data is unavailable...");
          msg.style.color = "red";
        }
        if (preMode && credentials) {
          request.AddParameter("LOGON_USERNAME", credentials[0]);
          request.AddParameter("LOGON_PASSWORD", credentials[1]);
          request.AddParameter("format", "mpbf-pre");
          request.AddParameter("id", efID);
        }
        else {
          request.AddParameter("format", "mpbf");
          request.AddParameter("id", efID);
        }
        request.Send(mpbfAPI);
      }
    }
    
    // wireframe representation
    function selectWireframe() {
      document.getElementById("option_field").childNodes[3].currentDisplayMode = selectWireframe;
      
      var model = canvas.molmilViewer.structures[0], chain, list, c, m, mol, a;
      list = molmil.interpolateBR(model.chains.length);
      for (c=0; c<model.chains.length; c++) {
        chain = model.chains[c];
        if (canvas.molmilViewer.sceneBU && ! canvas.molmilViewer.sceneBU.chainInfo.hasOwnProperty(chain.name)) continue
        chain.displayMode = 1;
        //chain.display = true;
        
        for (m=0; m<chain.molecules.length; m++) {
          mol = chain.molecules[m];
          mol.rgba = list[c];
          for (a=0; a<mol.atoms.length; a++) {
            mol.atoms[a].displayMode = 4;
            mol.atoms[a].rgba = list[c];
          }
          mol.displayMode = 0;
          if (mol.ligand) {
            for (a=0; a<mol.atoms.length; a++) mol.atoms[a].rgba = molmil_dep.getKeyFromObject(molmil.configBox.elementColors, mol.atoms[a].element, molmil.configBox.elementColors.DUMMY);
          }
        }
      }
      
      canvas.displayMode = 4;
      
      for (var f=0; f<canvas.fgroups.length; f++) canvas.fgroups[f].update = canvas.fgroups[f].enabled;
      
      displaySites();
    }
    
    // cartoon representation (with HETATM)
    function selectDisplayDefault() {
      document.getElementById("option_field").childNodes[3].currentDisplayMode = selectDisplayDefault;
      
      var model = canvas.molmilViewer.structures[0], chain, list, c, m, mol, a;
      list = molmil.interpolateBR(model.chains.length);
      for (c=0; c<model.chains.length; c++) {
        chain = model.chains[c];
        if (canvas.molmilViewer.sceneBU && ! canvas.molmilViewer.sceneBU.chainInfo.hasOwnProperty(chain.name)) continue
        chain.displayMode = 3;
        //chain.display = true;
        for (m=0; m<chain.molecules.length; m++) {
          mol = chain.molecules[m];
          mol.rgba = list[c];
          if (mol.ligand) for (a=0; a<mol.atoms.length; a++) {mol.atoms[a].displayMode = 3; mol.atoms[a].rgba = molmil_dep.getKeyFromObject(molmil.configBox.elementColors, mol.atoms[a].element, molmil.configBox.elementColors.DUMMY);}
          else {for (a=0; a<mol.atoms.length; a++) mol.atoms[a].displayMode = 0;}
          
          mol.displayMode = 3;
        }
      }
      canvas.displayMode = 1;
      
      for (var f=0; f<canvas.fgroups.length; f++) canvas.fgroups[f].update = canvas.fgroups[f].enabled;
      
      displaySites();
    }
    
    // CPK representation
    function selectDisplayCPK() {
      document.getElementById("option_field").childNodes[3].currentDisplayMode = selectDisplayCPK;
      
      canvas.displayMode = 2;
      
      var model = canvas.molmilViewer.structures[0], chain, list, c, m, mol, a;
      list = molmil.interpolateBR(model.chains.length);
      for (c=0; c<model.chains.length; c++) {
        chain = model.chains[c];
        if (canvas.molmilViewer.sceneBU && ! canvas.molmilViewer.sceneBU.chainInfo.hasOwnProperty(chain.name)) continue
        chain.displayMode = 1;
        //chain.display = true;
        for (m=0; m<chain.molecules.length; m++) {
          mol = chain.molecules[m];
          if (mol.ligand) for (a=0; a<mol.atoms.length; a++) {mol.atoms[a].displayMode = 3; mol.atoms[a].rgba = molmil_dep.getKeyFromObject(molmil.configBox.elementColors, mol.atoms[a].element, molmil.configBox.elementColors.DUMMY);}
          else if (! mol.water) for (a=0; a<mol.atoms.length; a++) {mol.atoms[a].displayMode = 1; mol.atoms[a].rgba = list[c];}
          else for (a=0; a<mol.atoms.length; a++) mol.atoms[a].displayMode = 0;
          mol.displayMode = 0;
        }
      }
      
      for (var f=0; f<canvas.fgroups.length; f++) canvas.fgroups[f].update = canvas.fgroups[f].enabled;
      displaySites();
    }
    
    // cartoon representation without HETATM
    function selectDisplayDefaultNoHET() {
      document.getElementById("option_field").childNodes[3].currentDisplayMode = selectDisplayDefaultNoHET;
      
      canvas.displayMode = 3;
      
      var model = canvas.molmilViewer.structures[0], chain, list, c, m, mol, a;
      list = molmil.interpolateBR(model.chains.length);
      for (c=0; c<model.chains.length; c++) {
        chain = model.chains[c];
        if (canvas.molmilViewer.sceneBU && ! canvas.molmilViewer.sceneBU.chainInfo.hasOwnProperty(chain.name)) continue
        chain.displayMode = 3;
        //chain.display = true;
        for (m=0; m<chain.molecules.length; m++) {
          mol = chain.molecules[m];
          mol.rgba = list[c];
          
          for (a=0; a<mol.atoms.length; a++) mol.atoms[a].displayMode = 0;
          mol.displayMode = 3;
        }
      }
      
      for (var f=0; f<canvas.fgroups.length; f++) canvas.fgroups[f].update = canvas.fgroups[f].enabled;
      displaySites();
    }
    
    
    
    // display all selected sites
    function displaySites() {
      var f, r, mol;
      for (f=0; f<canvas.fgroups.length; f++) if (canvas.fgroups[f].update) {
        if (canvas.displayMode == 1 || canvas.displayMode == 3) { // cartoon sse + ball-n-stick side chains
          if (canvas.fgroups[f].enabled) {
            for (r=0; r<canvas.fgroups[f].residueList.length; r++) {
              mol = canvas.fgroups[f].residueList[r];
              mol.rgba_prev = mol.rgba_prev || mol.rgba;
              mol.rgba = canvas.fgroups[f].color;
              for (a=0; a<mol.atoms.length; a++) if (! molmil.configBox.backboneAtoms4Display.hasOwnProperty(mol.atoms[a].atomName)) {mol.atoms[a].displayMode = mol.atoms[a].atomName == "CA" ? 3 : 2; mol.atoms[a].rgba = molmil_dep.getKeyFromObject(molmil.configBox.elementColors, mol.atoms[a].element, molmil.configBox.elementColors.DUMMY);}
              mol.showSC = true;
            }
          }
          else {
            for (r=0; r<canvas.fgroups[f].residueList.length; r++) {
              mol = canvas.fgroups[f].residueList[r];
              mol.rgba = mol.rgba_prev || mol.rgba; mol.rgba_prev = null;
              for (a=0; a<mol.atoms.length; a++) mol.atoms[a].displayMode = 0;
              mol.showSC = false;
            }
          }
        }
        else if (canvas.displayMode == 2 || canvas.displayMode == 4) { // cpk or wireframe
          if (canvas.fgroups[f].enabled) {
            for (r=0; r<canvas.fgroups[f].residueList.length; r++) {
              mol = canvas.fgroups[f].residueList[r];
              for (a=0; a<mol.atoms.length; a++) {mol.atoms[a].rgba_prev = mol.atoms[a].rgba_prev || mol.atoms[a].rgba; mol.atoms[a].rgba = canvas.fgroups[f].color;}
              mol.showSC = true;
            }
          }
          else {
            for (r=0; r<canvas.fgroups[f].residueList.length; r++) {
              mol = canvas.fgroups[f].residueList[r];
              for (a=0; a<mol.atoms.length; a++) {mol.atoms[a].rgba = mol.atoms[a].rgba_prev; mol.atoms[a].rgba_prev = null;}
              mol.showSC = false;
            }
          }
        }
        molmil.geometry.reInitChains = true;
        canvas.fgroups[f].update = false;
      }
      
      canvas.renderer.initBuffers();
      canvas.update = true;
    }
    
    function toggleSite() {
      this.data.enabled = this.checked;
      this.data.update = true;
      
      displaySites();
    }
    
function mmjsonGroupData(obj, field) {
  if (! obj) return {};
  var output = {}, tmp;
  var keys = Object.keys(obj);
  for (var i=0; i<obj[field].length; i++) {
    if (! output.hasOwnProperty(obj[field][i])) output[obj[field][i]] = [];
    tmp = {};
    for (k=0; k<keys.length; k++) tmp[keys[k]] = obj[keys[k]][i];
    output[obj[field][i]].push(tmp);
  }
  return output;
}
    
    
    window.onhashchange = function() {initViewer();}
    
  </script>
  
  </head>
  
  <body onload="initViewer();">
    
    <center>
      <span>
        <a href="https://pdbj.org/eF-site/" id="goto_top">Goto eF-site top</a>
        <img src="https://pdbj.org/eF-site/img/title_small.jpg" style="vertical-align: bottom; margin-right: 1em;" />
        <span id="pdbid_container"></span>
      </span>
      <br />
      <span class="molmil_UI_container">
        <canvas id="molmilViewer"></canvas>
      </span>
      <span class="molmil_UI_container">
        <canvas id="molmilViewer2"></canvas>
      </span>
      <span id="infoBox"></span>
      <span id="option_field" style="display: none;">
        <span>Chain selection:</span>
        <select></select>
      </span>
      <hr />
      <span id="fSiteBox"></span>
    </center>
    
  </body>
  
  <script src="../molmil.js"></script>
</html>
